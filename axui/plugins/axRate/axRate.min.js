/*!
 *Last modified: 2022-11-26 21:36:30
 *名称: axRate.js
 *简介: 评星插件的js文件
 *用法: new axRate('#id',{参数})
 *版本: v1.0.2
 *演示: https://www.axui.cn/v2.0/ax-rate.php
 *客服: 3217728223@qq.com
 *交流: QQ群952502085
 *作者: AXUI团队
 */
class t{constructor(t,i){this.targetDom=axIdToDom(t),this.options=axExtend({half:!1,icon:"ax-iconfont ax-icon-star-f",count:5,multiplier:1,value:0,readonly:!1,popShow:!1,popTheme:"ad",popFormat:"<i stars></i>星,总分:<i value></i>",tipsShow:!1,tipsFormat:"<i stars></i>星,总分:<i value></i>",clearShow:!1,size:"",rendered:"",getValue:"",setValue:""},i,this.targetDom,"axRate"),this.handlers={},this.targetDom&&"INPUT"!=this.targetDom.nodeName?this.parent=this.targetDom:(this.parent=axAddElem("div",{class:"ax-rate"}),"INPUT"==this.targetDom.nodeName&&(this.hidden=this.targetDom,this.hidden.insertAdjacentElement("beforeBegin",this.parent),"hidden"!=this.hidden.type&&(this.hidden.style.display="none"))),this.value=0,this.stars=0,this.items=[],this.init()}init(){let t,i=this;this.renderRate(),this.set(this.options.value),this.options.popShow&&(t=axAddElem("div",{class:"ax-rate-popcon"},this.options.popFormat),this.tooltip=new axTooltip(this.items[0].dom,{trigger:"none",theme:this.options.popTheme,content:t}),new axHover(i.ul,{enter:()=>{i.tooltip.popup.show()},leave:()=>{i.tooltip.popup.hide()},hold:i.tooltip.popup.targetDom})),this.options.readonly||(this.clear.onclick=function(){i.set(0)},this.items.forEach(e=>{let s=e.dom,l=s.firstElementChild,a=this.items.filter(t=>t.id<e.id),o=this.items.filter(t=>t.id>e.id);this.options.popShow&&new axHover(s,{enter:()=>{i.tooltip.popup.updatePosition(s)}}),s.onmousemove=function(s){let h=i.movePlace(s,this);a.forEach(t=>{t.dom.firstElementChild.classList.add("ax-full"),t.value=1}),"half"==h?(l.classList.remove("ax-full"),l.classList.add("ax-half")):"full"==h&&(l.classList.remove("ax-half"),l.classList.add("ax-full")),o.forEach(t=>{t.dom.firstElementChild.classList.remove("ax-half"),t.dom.firstElementChild.classList.remove("ax-full")}),i.options.popShow&&i.calculate(e,h,t),this.onclick=function(){e.value="half"==h?.5:"full"==h?1:0,i.calculate(e,h),i.options.tipsShow&&(i.tipsValue&&(i.tipsValue.innerHTML=i.value),i.tipsStars&&(i.tipsStars.innerHTML=i.stars)),i.options.getValue&&i.options.getValue.call(i,i.value,i.stars),"getValue"in i.handlers&&i.emit("getValue",i.value,i.stars)}}}),this.ul.onmouseleave=function(){i.set(i.value),i.options.setValue&&i.options.setValue.call(i,i.value,i.stars),"setValue"in i.handlers&&i.emit("setValue",i.value,i.stars)})}set(t){t<=0&&(t=0),t>=this.options.multiplier*this.options.count&&(t=this.options.multiplier*this.options.count);let i=t/this.options.multiplier,e=Math.floor(i),s=i-e;if(this.options.half||(s=0),t)for(let t=0;t<=e-1;t++){let i=this.items[t].dom.firstElementChild;i.classList.remove("ax-half"),i.classList.add("ax-full"),this.items[t].value=1}else this.items.forEach(t=>{let i=t.dom.firstElementChild;i.classList.remove("ax-half"),i.classList.remove("ax-full"),t.value=0});if(this.stars=e,.5==s){let t=this.items[e].dom.firstElementChild;t.classList.remove("ax-full"),t.classList.add("ax-half"),this.items[e].value=.5,this.stars+=.5,e++}for(let t=e;t<this.items.length;t++){let i=this.items[t].dom.firstElementChild;i.classList.remove("ax-half"),i.classList.remove("ax-full"),this.items[t].value=0}this.value=t,this.tipsValue&&(this.tipsValue.innerHTML=t),this.tipsStars&&(this.tipsStars.innerHTML=this.stars),this.hidden&&(this.hidden.value=t)}get(t){return{stars:this.stars,value:this.value,count:this.options.count,multiplier:this.options.multiplier}[t]}calculate(t,i,e){let s=this.items.filter(i=>i.id<t.id).length;"half"==i?s+=.5:"full"==i&&s++,e?(e.querySelector("[stars]").innerHTML=s,e.querySelector("[value]").innerHTML=this.options.multiplier*s):(this.value=this.options.multiplier*s,this.stars=s)}renderRate(){let t=document.createDocumentFragment(),i=`<li class="ax-item">\n                            ${`<i class="${this.options.icon}"></i>`.repeat(2)}\n                        </li>`;this.ul=axAddElem("ul"),this.tips=axAddElem("div",{class:"ax-tips"},this.options.tipsFormat),this.tipsStars=this.tips.querySelector("[stars]"),this.tipsValue=this.tips.querySelector("[value]"),this.clear=axAddElem("i",{class:"ax-iconfont ax-icon-close-o-f",clear:""}),this.options.clearShow&&t.appendChild(this.clear);for(let t=1;t<=this.options.count;t++){let e=axStrToDom(i),s={id:t,value:0,dom:e};this.items.push(s),this.ul.appendChild(e)}t.appendChild(this.ul),this.options.tipsShow&&t.appendChild(this.tips),this.options.size&&this.parent.setAttribute("size",this.options.size),this.parent.appendChild(t),this.options.rendered&&this.options.rendered.call(this),"rendered"in this.handlers&&this.emit("rendered","")}movePlace(t,i){if(!this.options.half)return"full";let e=i.getBoundingClientRect().left,s=e+~~((i.getBoundingClientRect().right-e)/2),l="full";return t.clientX<s&&(l="half"),l}on(t,i){return axAddPlan(t,i,this),this}emit(t,...i){axExePlan(t,this,...i)}off(t,i){return axDelPlan(t,i,this),this}}document.querySelectorAll("[axRate]").forEach(i=>{new t(i)});