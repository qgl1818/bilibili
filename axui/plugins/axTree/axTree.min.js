/*!
 *Last modified: 2023-03-15 23:21:26
 *名称: axTree.js
 *简介: tree树菜单的js文件
 *用法: new axTree('#id',{参数})
 *版本: v1.0.5
 *演示: https://www.axui.cn/v2.0/ax-tree.php
 *客服: 3217728223@qq.com
 *交流: QQ群952502085
 *作者: AXUI团队
 */
class e{constructor(e,t){this.targetDom=axIdToDom(e),this.options=axExtend({insName:"",storageName:"",toggle:!0,collapseAll:!0,disabled:[],expanded:[],checked:[],selected:"",oneSelected:!0,arrowIcon:["ax-icon-right","ax-icon-right","ax-none"],parentIcon:["ax-icon-folder","ax-icon-folder-open"],childIcon:"ax-icon-file-text",iconShow:!1,checkboxIcon:["ax-icon-square","ax-icon-check-s","ax-icon-check-s-f"],radioIcon:["ax-icon-circle","ax-icon-radio","ax-icon-radio-f"],checkShow:!1,checkType:"checkbox",checkMin:0,checkMax:1e6,linkage:!0,oneRadio:!1,readonly:"",url:"",inputWidth:"",toolsShow:!1,toolsAction:"hover",addTools:[],firstFloor:-1,idStart:0,draggable:!1,line:!1,async:"",ajaxType:"post",delay:0,fields:"",content:"",onBeforeRemove:"",onGetCheckeds:"",onInit:"",onCollapse:"",onExpand:"",onCollapsed:"",onExpanded:"",onCollapseAll:"",onExpandAll:"",onSetReadonly:"",onSetDisabled:"",onSetChecked:"",onSearched:"",onRemoved:"",onEditing:"",onEdited:"",onAdded:"",onSelected:"",onPlanted:"",onClickCheck:"",onDropped:"",onTooMuch:"",onTooLittle:"",onDestroy:"",onSave:"",onUpdate:"",onUpdateContent:""},t,this.targetDom,this.constructor.name),this.handlers={},this.checked=[],this.checkeds=[],this.expanded=[],this.expandeds=[],this.selected=this.options.selected,this.options.oneSelected&&!axIsEmpty(this.selected)&&this.selected.shift(),this.selecteds=[],this.disabled=this.options.disabled,this.disableds=[],this.searchs=[],this.readonlys=[],this.arrowSame=this.options.arrowIcon[0]==this.options.arrowIcon[1],this.arrow=axAddElem("i",{class:"ax-iconfont",arrow:""}),this.checkIcon={checkbox:['<i class="ax-iconfont '+this.options.checkboxIcon[0]+'" check></i>','<i class="ax-iconfont '+this.options.checkboxIcon[1]+'" check></i>','<i class="ax-iconfont '+this.options.checkboxIcon[2]+'" check></i>'],radio:['<i class="ax-iconfont '+this.options.radioIcon[0]+'" check></i>','<i class="ax-iconfont '+this.options.radioIcon[1]+'" check></i>','<i class="ax-iconfont '+this.options.radioIcon[2]+'" check></i>']},this.fileIcon="",this.options.iconShow&&(this.fileIcon={parent:'<i class="ax-iconfont '+this.options.parentIcon[0]+'" legend></i>',child:'<i class="ax-iconfont '+this.options.childIcon+'" legend></i>'}),this.maxFloor=0,this.rawHTML="",this.init()}init(){if(axInstance.push(this,this.options.insName,"tree"),this.destroyed=!1,this.flatData=[],this.treeData=[],this.options.storageName){let e=axLocalStorage.get(this.options.storageName);axIsEmpty(e)?axLocalStorage.set(this.options.storageName,{}):this.options=axExtend(this.options,e)}let e=this;if("String"==axType(this.options.content)&&this.options.async)"json"==this.options.async?this.contentXhr=axAjax({url:this.options.content,type:this.options.ajaxType,success:function(t){if(axIsEmpty(t))return console.warn("No data obtained from json!"),!1;e.toTree(t),e.dataProcess(e.treeData)}},this.targetDom):"sql"==this.options.async&&(this.contentXhr=axAjax({data:{pId:e.options.firstFloor},type:this.options.ajaxType,url:this.options.content,success:function(t){if(axIsEmpty(t))return console.warn("No data obtained from the database!"),!1;e.toTree(t),e.dataProcess(e.treeData)}},this.targetDom));else{if("Array"==axType(this.options.content)){if(0===this.options.content.length)return console.warn("Array is empty!"),!1;this.toTree(this.options.content)}else axType(this.options.content).includes("HTML")||axStrType(this.options.content)?this.treeData=axUlToArr(this.options.content,this.options.idStart,!0):this.targetDom.innerHTML&&(this.treeData=axUlToArr(this.targetDom,this.options.idStart,!0),this.rawHTML=this.targetDom.innerHTML);this.dataProcess(this.treeData)}}toTree(e){e[0].hasOwnProperty("pId")?this.treeData=axArrToTree(e,this.options.firstFloor):this.treeData=e}dataProcess(e){let t=this;if(this.flatData=axArrToFlat(e),this.targetDom.innerHTML="",this.setAttribute(),!this.fixChecked(this.flatData))return!1;this.refreshTree(e),this.fixExpand(this.flatData),this.arrayToDom(e),this.flatData.forEach(e=>{axIsEmpty(this.expanded)&&!this.options.collapseAll&&e.children&&(e.expanded=!1,this.ulToggle(e)),this.renderFinish(e,t.flatData)}),this.options.onInit&&this.options.onInit.call(this),"init"in this.handlers&&this.emit("init","")}setAttribute(){this.options.line&&this.targetDom.setAttribute("line","")}dragPlace(e,t){let i=t.getBoundingClientRect().top,o=t.getBoundingClientRect().bottom,s=(t.getBoundingClientRect().bottom-t.getBoundingClientRect().top)/3,a=i+~~s,n=o-~~s,h="child";return e.clientY<a?h="up":e.clientY>n&&(h="down"),h}resetRelation(e,t,i,o){let s=(e,t)=>{"1-0"==o?(e.pId=this.options.firstFloor,e.path=this.options.firstFloor+">"+e.id,e.floor=1,e.indentDom.innerHTML=""):"0-1"!=o&&"other"!=o&&o||(e.pId=t.id,e.path=t.path+">"+e.id,e.floor=t.floor+1,e.indentDom.innerHTML="<i></i>".repeat(e.floor-1))},a=(e,t)=>{e.children&&e.children.length>0?e.children.forEach(t=>{s(t,e),a(t,e)}):s(e,t)};s(e,t),a(e,t),"0-1"==o?this.treeData=this.treeData.filter(t=>t.id!=e.id):"0-0"==o||"1-0"==o||(i.children=i.children.filter(t=>t.id!=e.id))}openParentBorn(e,t,i,o){let s=e.headerDom.nextElementSibling;if(t){let a=t.headerDom.parentElement;this.resetRelation(t,e,i,o),e.expanded||(e.headerDom.setAttribute("expanded","true"),e.expanded=!0,s.style.display="block"),e.children.unshift(t),s.insertAdjacentElement("afterBegin",a)}}childToParentBorn(e,t,i,o){let s=this;if(e.children)return!1;{let a=axAddElem("ul",{style:"display:block"});if(e.arrowDom.classList.remove(this.options.arrowIcon[2]),e.arrowDom.classList.add(this.options.arrowIcon[0]),e.headerDom.setAttribute("expanded","true"),e.expanded=!0,e.children=[],t){let s=t.headerDom.parentElement;this.resetRelation(t,e,i,o),e.children.unshift(t),a.insertAdjacentElement("afterBegin",s)}e.headerDom.insertAdjacentElement("afterEnd",a),e.arrowDom.onclick=function(){s.ulToggle(e)}}}dropItem(e,t,i,o,s){let a=t.headerDom,n=a.parentElement,h=this.flatData.filter(t=>e.pId==t.id.toString())[0],l=e.headerDom.parentElement,r="up"==o?"beforeBegin":"down"==o?"afterEnd":"",d=o=>{if(this.resetRelation(t,h,i,s),"0-0"==s){let i=this.treeData.indexOf(t),s=this.treeData.indexOf(e);"up"==o?axMoveArr(this.treeData,i,s):"down"==o&&axMoveArr(this.treeData,i,s+1)}else if("1-0"==s){let i,s=this.treeData.indexOf(e);"up"==o?i=s:"down"==o&&(i=s+1),this.treeData.splice(i,0,t)}else{let i,s=h.children.indexOf(e);"up"==o?i=s:"down"==o&&(i=s+1),h.children.splice(i,0,t)}l.insertAdjacentElement(r,n)};if("up"==o){if(l.previousElementSibling==n)return!1;d("up")}else if("down"==o){if(l.nextElementSibling==n)return!1;d("down")}else e.children?this.openParentBorn(e,t,i,s):this.childToParentBorn(e,t,i,s);a.setAttribute("tabindex","-1"),a.focus(),a.onblur=function(){a.removeAttribute("tabindex")},this.options.onDropped&&this.options.onDropped.call(this,t,e),"dropped"in this.handlers&&this.emit("dropped",t,e)}ulToggle(e,t=!0){let i=e.headerDom,o=e.arrowDom,s=e.legendDom,a=i.nextElementSibling;1==e.expanded?(this.options.onCollapse&&this.options.onCollapse.call(this,e),"collapse"in this.handlers&&this.emit("collapse",e),e.expanded=!1,i.removeAttribute("expanded"),this.arrowSame||(o.classList.remove(this.options.arrowIcon[1]),o.classList.add(this.options.arrowIcon[0])),this.options.iconShow&&(s.classList.remove(this.options.parentIcon[1]),s.classList.add(this.options.parentIcon[0])),this.eachExapand(e),axSlideUp(a,()=>{this.options.onCollapsed&&this.options.onCollapsed.call(this,e),"collapsed"in this.handlers&&this.emit("collapsed",e)})):(this.options.onExpand&&this.options.onExpand.call(this,e),"expand"in this.handlers&&this.emit("expand",e),e.expanded=!0,i.setAttribute("expanded","true"),this.arrowSame||(o.classList.remove(this.options.arrowIcon[0]),o.classList.add(this.options.arrowIcon[1])),this.options.iconShow&&(s.classList.remove(this.options.parentIcon[0]),s.classList.add(this.options.parentIcon[1])),this.eachExapand(e),axSlideDown(a,()=>{this.options.onExpanded&&this.options.onExpanded.call(this,e),"expanded"in this.handlers&&this.emit("expanded",e)}),t&&this.siblingsCollapse(this.flatData,e)),this.save()}clickCheck(e,t){let i=this;e.checkDom.onclick=function(){if(!e.checkDom||e.disabled)return!1;if(i.checkeds.length>i.options.checkMax&&!e.checked)return console.warn("The length of checked is too much!"),i.options.onTooMuch&&i.options.onTooMuch.call(i,i.checkeds.length,i.options.checkMax),"tooMuch"in i.handlers&&i.emit("tooMuch",i.checkeds.length,i.options.checkMax),!1;if("checkbox"==i.options.checkType)1==e.checked?e.checked=!1:e.checked=!0,i.eachCheckbox(e,i.options.linkage),i.options.onGetCheckeds&&i.options.onGetCheckeds.call(i,i.checkeds,e);else if("radio"==i.options.checkType){if(t.filter(t=>t.pId==e.pId).some(e=>1==e.checked&&1==e.disabled))return console.warn("You must uncheck the disabled item that have been checked!"),!1;if(i.options.oneRadio&&t.some(e=>1==e.checked&&1==e.disabled))return console.warn("You must uncheck the disabled item that have been checked!"),!1;1==e.checked?e.checked=!1:e.checked=!0,i.eachRadio(e,i.options.linkage),i.options.onGetCheckeds&&i.options.onGetCheckeds.call(i,i.checkeds,e)}i.options.onClickCheck&&i.options.onClickCheck.call(i,i.checkeds,e),"clickCheck"in i.handlers&&i.emit("clickCheck",i.checkeds,e)}}siblingsCollapse(e,t){if(this.options.toggle){let i=e.filter(e=>e.pId==t.pId&&e.children&&e!=t);for(let e=0,t=i.length;e<t;e++){let t=i[e];t.headerDom.nextElementSibling&&(t.expanded=!0,this.ulToggle(t))}}}renderFinish(e,t){let i=this,o=e.headerDom.parentElement;e.arrowDom.classList.contains(this.options.arrowIcon[2])||(e.arrowDom.onclick=function(){if(!e.expanded&&"sql"==i.options.async){let t=e.headerDom.nextElementSibling;t||(t=axAddElem("ul"),e.headerDom.insertAdjacentElement("afterEnd",t)),t.querySelector("li")||axAjax({data:{pId:e.id},type:i.options.ajaxType,url:i.options.content,before:function(){e.arrowDom.setAttribute("loading","")},success:function(o){e.arrowDom.removeAttribute("loading"),t.innerHTML="",o.forEach(t=>{i.add(t,e,!0,!1)})}})}i.ulToggle(e)}),this.selected.includes(e.id)&&(e.selected=!0,this.eachSelect(e)),this.options.checkShow&&(this.disabled.includes(e.id)&&(e.disabled=!0,this.eachDisabled(e)),this.checked.includes(e.id)&&(e.checked=!0,"checkbox"==this.options.checkType?this.eachCheckbox(e,this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(e,this.options.linkage)),this.clickCheck(e,t)),this.options.toolsShow&&(e.removeDom.onclick=function(){if(e.readonly)return!1;if(i.options.onBeforeRemove){i.options.onBeforeRemove.call(i,e,e.removeDom)&&i.remove(e)}else i.remove(e)},e.editDom.onclick=function(){if(e.readonly)return!1;i.edit(e)},e.addDom.onclick=function(){if(e.readonly)return!1;i.add("",e)}),e.labelDom&&(e.labelDom.onclick=function(){if(e.headerDom.hasAttribute("editing"))return!1;let o=t.filter(t=>t!=e);1==e.selected?(e.selected=!1,i.eachSelect(e)):(e.selected=!0,i.eachSelect(e),i.options.oneSelected&&o.forEach(e=>{1==e.selected&&(e.selected=!1,i.eachSelect(e))}),i.options.onSelected&&i.options.onSelected.call(i,e),"selected"in i.handlers&&i.emit("selected",e)),e.toolsDom&&"click"==i.options.toolsAction&&(e.selected?e.toolsDom.style.display="inline-block":e.toolsDom.style.display="none")},e.labelDom.ondblclick=function(){if(e.readonly)return!1;i.edit(e)}),1==this.options.draggable?(o.setAttribute("draggable","true"),o.addEventListener("dragstart",(function(t){t.stopPropagation(),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("id",e.id)}),!1)):"Array"==axType(this.options.draggable)&&this.options.draggable.includes(e.id)&&(o.setAttribute("draggable","true"),o.addEventListener("dragstart",(function(t){t.stopPropagation(),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("id",e.id)}),!1)),e.headerDom.addEventListener("dragenter",(function(e){e.preventDefault()}),!1),e.headerDom.addEventListener("dragover",(function(t){t.preventDefault(),o.classList.add("ax-dragging"),o.setAttribute("insert",i.dragPlace(t,e.headerDom))}),!1),e.headerDom.addEventListener("dragleave",(function(e){e.preventDefault(),o.classList.remove("ax-dragging"),o.removeAttribute("insert")}),!1),e.headerDom.addEventListener("drop",(function(t){t.preventDefault();let s,a=t.dataTransfer.getData("id"),n=i.flatData.filter(e=>a==e.id.toString())[0],h=i.flatData.filter(e=>n.pId==e.id)[0];if(s=e.pId==n.pId&&e.pId==i.options.firstFloor&&"child"!=i.dragPlace(t,e.headerDom)?"0-0":e.pId==i.options.firstFloor&&"child"!=i.dragPlace(t,e.headerDom)?"1-0":n.pId==i.options.firstFloor?"0-1":"other",o.classList.remove("ax-dragging"),o.removeAttribute("insert"),e==n)return!1;i.dropItem(e,n,h,i.dragPlace(t,e.headerDom),s)}),!1),this.save()}getParents(e,t="obj"){let i=[],o=[];if("Array"==axType(e)){this.flatData.filter(t=>e.includes(t.id)).forEach(e=>{let t=e.path.split(">").filter(t=>t.id!=this.options.firstFloor&&t!=e.id);i.push(...t)})}else if("Object"==axType(e)){let t=e.path.split(">").filter(t=>t.id!=this.options.firstFloor&&t!=e.id);i.push(...t)}else{let t=this.flatData.filter(t=>t.id==e)[0],o=t.path.split(">").filter(e=>e.id!=this.options.firstFloor&&e!=t.id);i.push(...o)}return i=[...i].filter((e,t)=>[...i].indexOf(e)==t),i=i.map(Number),o=this.flatData.filter(e=>i.includes(e.id)),"obj"==t?o:"id"==t?i:{obj:o,id:i}}getChildren(e){let t=[];return"Array"==axType(e)?e.forEach(e=>{let i=this.flatData.filter(t=>t.path.includes(">"+e+">"));t.push(...i)}):t="Object"==axType(e)?this.flatData.filter(t=>t.path.includes(">"+e.id+">")):this.flatData.filter(t=>t.path.includes(">"+e+">")),t}eachSelect(e){if(1==e.selected)e.headerDom.setAttribute("selected","true"),!this.selecteds.includes(e.id)&&this.selecteds.push(e.id);else{e.headerDom.removeAttribute("selected");for(let t=0;t<this.selecteds.length;t++)if(this.selecteds[t]==e.id){this.selecteds.splice(t,1);break}}}eachDisabled(e){let t=(e,t)=>{if(t)e.headerDom.setAttribute("disabled","true"),!this.disableds.includes(e.id)&&this.disableds.push(e.id);else{e.headerDom.removeAttribute("disabled");for(let t=0;t<this.disableds.length;t++)if(this.disableds[t]==e.id){this.disableds.splice(t,1);break}}},i=(e,o)=>{if(e.disabled=o,t(e,o),e.children&&e.children.length>0){[...e.children].filter(e=>!e.disabled).forEach(e=>{i(e,o)})}};1==e.disabled?(t(e,!0),"checkbox"==this.options.checkType&&i(e,!0)):(t(e,!1),"checkbox"==this.options.checkType&&i(e,!1))}eachExapand(e){if(1==e.expanded)e.headerDom.setAttribute("expanded","true"),!this.expandeds.includes(e.id)&&this.expandeds.push(e.id);else{e.headerDom.removeAttribute("expanded");for(let t=0;t<this.expandeds.length;t++)if(this.expandeds[t]==e.id){this.expandeds.splice(t,1);break}}}checkToggle(e,t,i){let o=e.headerDom,s=o.querySelector("[check]"),a="checkbox"==i?"checkboxIcon":"radio"==i?"radioIcon":"";1==t?(e.checked=!0,o.setAttribute("checked","true"),s.classList.remove(this.options[a][0],this.options[a][1]),s.classList.add(this.options[a][2])):0==t?(e.checked=!1,o.setAttribute("checked","false"),s.classList.remove(this.options[a][1],this.options[a][2]),s.classList.add(this.options[a][0])):"ing"==t&&(e.checked="ing",o.setAttribute("checked","ing"),s.classList.remove(this.options[a][0],this.options[a][2]),s.classList.add(this.options[a][1]))}eachCheckbox(e,t){if(t){let t=e=>{e.children?1==e.checked?(this.checkToggle(e,!0,"checkbox"),e.children.forEach(e=>{e.disabled||(e.checked=!0,t(e))})):e.checked||(this.checkToggle(e,!1,"checkbox"),e.children.forEach(e=>{e.disabled||(e.checked=!1,t(e))})):1==e.checked?this.checkToggle(e,!0,"checkbox"):e.checked||this.checkToggle(e,!1,"checkbox")},i=e=>{let t=e.path.split(">").filter(t=>t!==this.options.firstFloor&&t!=e.id);this.flatData.filter(e=>t.includes(e.id.toString())).reverse().forEach(e=>{e.children.filter(e=>!e.disabled).every(e=>!e.checked)?this.checkToggle(e,!1,"checkbox"):e.children.filter(e=>!e.disabled).every(e=>1==e.checked)?this.checkToggle(e,!0,"checkbox"):e.children.some(e=>1==e.checked||"ing"==e.checked)&&this.checkToggle(e,"ing","checkbox")})};t(e),i(e)}else 1==e.checked?this.checkToggle(e,!0,"checkbox"):e.checked?this.checkToggle(e,"ing","checkbox"):this.checkToggle(e,!1,"checkbox");this.checkeds=[],this.flatData.filter(e=>1==e.checked).forEach(e=>{this.checkeds.push(e.id)}),this.checkeds.length>this.options.checkMax?(console.warn("The length of checked is too much!"),this.options.onTooMuch&&this.options.onTooMuch.call(this,this.checkeds.length,this.options.checkMax),"tooMuch"in this.handlers&&this.emit("tooMuch",this.checkeds.length,this.options.checkMax)):this.checkeds.length<this.options.checkMin&&(console.warn("The length of checked is too little!"),this.options.onTooLittle&&this.options.onTooLittle.call(this,this.checkeds.length,this.options.checkMin),"tooLittle"in this.handlers&&this.emit("tooLittle",this.checkeds.length,this.options.checkMin))}eachRadio(e,t){if(1==e.checked){let t=[];t=this.options.oneRadio?this.flatData.filter(t=>1==t.checked&&t!=e):this.flatData.filter(t=>t.pId==e.pId&&1==t.checked&&t!=e),t.forEach(e=>{this.checkToggle(e,!1,"radio")}),this.checkToggle(e,!0,"radio")}else this.checkToggle(e,!1,"radio");if(t){(()=>{let t=this.flatData.filter(e=>1==e.checked),i=[];t.forEach(e=>{let t=e.path.split(">").filter(t=>t!==this.options.firstFloor&&t!=e.id);i.push(...t)}),i=[...i].filter((function(e,t){return[...i].indexOf(e)==t}));let o=this.flatData.filter(e=>i.includes(e.id.toString()));this.flatData.filter(t=>t.children&&t!=e&&!t.checked).forEach(e=>{e.checked&&this.checkToggle(e,!1,"radio")}),axIsEmpty(o)||o.forEach(e=>{1==e.checked?this.checkToggle(e,!0,"radio"):this.checkToggle(e,"ing","radio")})})()}this.checkeds=[],this.flatData.filter(e=>1==e.checked).forEach(e=>{this.checkeds.push(e.id)})}arrange(e){let t=[];return e.forEach((i,o)=>{e.slice(o+1,e.length).forEach(e=>{let o=[];o=[i,e],t.push(o)})}),t}fixChecked(e){let t=!0;return this.options.checked.length>this.checkMax?(console.warn("The length of checked has been automatically intercepted!"),this.options.onTooMuch&&this.options.onTooMuch.call(this,this.options.checked.length,this.checkMax),"tooMuch"in this.handlers&&this.emit("tooMuch",this.options.checked.length,this.checkMax),this.checked=this.options.checked.splice(this.checkMax)):this.checked=this.options.checked,this.checked.length<this.checkMin&&(console.error("The length of checked has exceeded the limit!"),this.options.onTooLittle&&this.options.onTooLittle.call(this,this.checked.length,this.checkMin),"tooLittle"in this.handlers&&this.emit("tooLittle",this.checked.length,this.checkMin),t=!1),"radio"==this.options.checkType&&this.checked.length>1?(t=!this.arrange(this.checked).some(t=>e.find(e=>e.id==t[0]).pId==e.find(e=>e.id==t[1]).pId),t||console.error("Only one item can be selected at the same level!")):this.options.checkType,t}fixExpand(e){let t=[];e.forEach(e=>{let i=e.path.split(">").filter(e=>e!==this.options.firstFloor);if(this.options.expanded.includes(~~i[i.length-1])&&t.push(...i),e.children&&e.children.length>0){let t=[];e.children.forEach(e=>{t.push(e.id)}),this.options.linkage&&(t.every(e=>this.checked.includes(e))?e.checked=!0:t.some(e=>this.checked.includes(e))&&(e.checked="ing"))}}),this.expanded=t.filter((function(e,i){return t.indexOf(e)==i})),this.expanded.forEach(t=>{let i=e.find(e=>t==e.id&&e.children);i&&(i.expanded=!0)})}createItem(e,t){let i=this,o="";"checkbox"==i.options.checkType&&i.options.checkShow?e.hasOwnProperty("checked")?1==e.checked?o=i.checkIcon.checkbox[2]:"ing"==e.checked&&(o=i.checkIcon.checkbox[1]):o=i.checkIcon.checkbox[0]:"radio"==i.options.checkType&&i.options.checkShow&&(e.hasOwnProperty("checked")?1==e.checked?o=i.checkIcon.radio[2]:"ing"==e.checked&&(o=i.checkIcon.radio[1]):o=i.checkIcon.radio[0]);let s=`<i class="${i.arrowSame?"":"ax-different"} ax-iconfont ${e.children?this.options.arrowIcon[0]:this.options.arrowIcon[2]}" arrow></i>`,a=`\n                        <div class="ax-node" >\n                            <span indent>${"<i></i>".repeat(t-1)}</span>\n                            ${s}\n                            ${o}\n                            <# if(this.children){ #>${i.fileIcon?i.fileIcon.parent:""}<# } else { #>${i.fileIcon?i.fileIcon.child:""} <# } #>\n                            <i label><# this.label #></i>\n                            ${i.options.toolsShow?'<span tools><i class="ax-iconfont ax-icon-plus" add></i><i class="ax-iconfont ax-icon-edit" edit></i><i class="ax-iconfont ax-icon-trash" remove></i></span>':""}\n                        </div>`;return e.headerDom=axStrToDom(axTplEngine(a,e)),e.toolsDom=e.headerDom.querySelector("[tools]"),e.indentDom=e.headerDom.querySelector("[indent]"),e.arrowDom=e.headerDom.querySelector("[arrow]"),e.labelDom=e.headerDom.querySelector("[label]"),e.legendDom=e.headerDom.querySelector("[legend]"),e.checkDom=e.headerDom.querySelector("[check]"),e.otherTools=[],axIsEmpty(this.options.addTools)||this.options.addTools.forEach(t=>{let o={dom:axStrToDom(t.dom),callback:t.callback};e.otherTools.push(o),o.dom.onclick=function(){o.callback.call(i,e)},e.toolsDom.insertAdjacentElement("afterBegin",o.dom)}),e.addDom=e.headerDom.querySelector("[add]"),e.editDom=e.headerDom.querySelector("[edit]"),e.removeDom=e.headerDom.querySelector("[remove]"),e.callback&&e.callback.call(this,e),e.headerDom}addAttritue(e,t){t.setAttribute("mark",e.id),this.options.readonly.includes(e.id)&&this.readonly(e),this.eachExapand(e),this.options.toolsShow&&t.setAttribute("toolsAction",this.options.toolsAction)}refreshTree(e){return this.maxFloor=axTreeMethod.addPath(e,this.options.firstFloor).maxFloor,this.flatData=axArrToFlat(this.treeData),e}arrayToDom(e){let t=axAddElem("ul"),i=document.createDocumentFragment(),o=(e,t)=>{let i=axAddElem("ul");return t.forEach(e=>{e.headerDom=this.createItem(e,e.floor),e.wrapperDom=axAddElem("li"),this.addAttritue(e,e.headerDom),e.wrapperDom.appendChild(e.headerDom),e.hasOwnProperty("children")&&o(e.wrapperDom,e.children),i.appendChild(e.wrapperDom)}),e.appendChild(i),e};o(t,e),[...t.childNodes[0].childNodes].forEach(e=>{i.appendChild(e)}),this.targetDom.appendChild(i),[...this.targetDom.querySelectorAll("[expanded]")].forEach(e=>{e.nextElementSibling.style.display="block"}),this.options.onPlanted&&this.options.onPlanted.call(this),"planted"in this.handlers&&this.emit("planted","")}add(e,t,i=!0,o=!0,s){if(this.destroyed)return this;let a;t||0===t?a=axFindItem(t,this.flatData):(a=this.flatData.filter(e=>1===e.floor).slice(-1)[0],i=!1,o=!1);let n=this,h=a.headerDom,l={};if(axIsEmpty(e)||"object"!=typeof e){let t=axIncreaseId(this.flatData),o=e&&"string"==typeof e?e:"新节点"+t;l=i?{id:t,label:o,pId:a.id,path:a.path+">"+t,floor:a.floor+1}:{id:t,label:o,pId:a.pId,path:a.path.replace(new RegExp("(.*)"+a.id),"$1"+t),floor:a.floor}}else{let t=i?{path:a.path+">"+e.id,floor:a.floor+1}:{path:a.path.replace(new RegExp("(.*)"+a.id),"$1"+e.id),floor:a.floor};l=Object.assign(e,t)}if(l.headerDom=this.createItem(l,l.floor),l.wrapperDom=axAddElem("li"),this.addAttritue(l,l.headerDom),l.wrapperDom.appendChild(l.headerDom),i)if(a.children){o?a.children.unshift(l):a.children.push(l),h.nextElementSibling.insertAdjacentElement(o?"afterBegin":"beforeEnd",l.wrapperDom),this.flatData.push(l),a.expanded||this.ulToggle(a)}else{a.children=[],o?a.children.unshift(l):a.children.push(l);let e=h.querySelector("[arrow]"),t=axAddElem("ul",{style:"display:block"});e.classList.remove(this.options.arrowIcon[2]),e.classList.add(this.options.arrowIcon[0]),a.expanded=!0,h.setAttribute("expanded","true"),t.insertAdjacentElement(o?"afterBegin":"beforeEnd",l.wrapperDom),h.insertAdjacentElement("afterEnd",t),this.flatData.push(l),this.siblingsCollapse(this.flatData,a),e.onclick=function(){n.ulToggle(a)}}else{let e=this.flatData.filter(e=>e.id==a.pId)[0],t=e?e.children:this.treeData,i=t.indexOf(a);o?0==i?t.unshift(l):t.splice(i,0,l):t.splice(i+1,0,l),h.parentElement.insertAdjacentElement(o?"beforeBegin":"afterEnd",l.wrapperDom),this.flatData.push(l),e&&!e.expanded&&(e.expanded=!0,this.ulToggle(e))}return this.renderFinish(l,this.flatData),l.headerDom.setAttribute("tabindex","-1"),l.headerDom.focus(),l.headerDom.onblur=function(){l.headerDom.removeAttribute("tabindex")},this.options.onAdded&&this.options.onAdded.call(this,l,a),"added"in this.handlers&&this.emit("added",l,a),s&&s.call(this,l,a),this.save(),this}edit(e,t){if(this.destroyed)return this;let i=this,o=axFindItem(e,this.flatData),s=o.headerDom,a=s.querySelector("[label]"),n=axAddElem("input",{type:"text"});return!s.hasAttribute("editing")&&(s.setAttribute("editing","true"),a.innerHTML="",a.appendChild(n),n.focus(),n.value=o.label,n.onblur=function(){s.removeAttribute("editing"),o.label=this.value,a.innerHTML=this.value,i.options.onEdited&&i.options.onEdited.call(i,o),"edited"in i.handlers&&i.emit("edited",o)},n.onkeyup=function(e){13==e.keyCode&&this.blur()},this.options.onEditing&&this.options.onEditing.call(this,o),"editing"in this.handlers&&this.emit("editing",o),t&&t.call(this,o),this.save(),this)}remove(e,t){if(this.destroyed)return this;let i=axFindItem(e,this.flatData);if(i.headerDom.parentElement.remove(),i.pId&&i.pId!=this.options.firstFloor){let e=this.flatData.filter(e=>e.id==i.pId)[0].children,t=e.indexOf(i);e.splice(t,1)}else this.treeData=this.treeData.filter(e=>e!=i);return this.flatData=this.flatData.filter(e=>e!=i&&!e.path.includes(">"+i.id+">")),this.options.onRemoved&&this.options.onRemoved.call(this,i),"removed"in this.handlers&&this.emit("removed",i),t&&t.call(this,i),this.save(),this}search(e,t){if(this.destroyed)return this;if(this.searchs.length>0){this.searchs.forEach(e=>{e.headerDom.querySelector("[label]").innerHTML=e.label}),this.treeData.filter(e=>"none"==e.headerDom.parentElement.style.display).forEach(e=>{e.headerDom.parentElement.removeAttribute("style")})}if(e){let t=[];this.searchs=this.flatData.filter(t=>t.label.includes(e)),this.searchs.forEach(i=>{t.push(i.id);let o=i.labelDom.innerHTML.replace(e,"<i>"+e+"</i>");i.labelDom.innerHTML=o});let i=this.getParents(t,"both");i.obj.forEach(e=>{e.expanded=!0,e.headerDom.setAttribute("expanded","true"),e.headerDom.nextElementSibling.style.display="block"});let o=[];i.obj.forEach(e=>{let t=this.flatData.filter(t=>t.pId=e.pId&&t!=e);o.push(...t)}),i.id=[...i.id,...t];let s=this.treeData.filter(e=>!i.id.includes(e.id));o.push(...s),this.flatData.filter(e=>!o.includes(e)).forEach(e=>{e.headerDom.parentElement.removeAttribute("style")});for(let e=0,t=o.length;e<t;e++){let t=o[e];"none"!=t.headerDom.parentElement.style.display&&(t.headerDom.parentElement.style.display="none")}}else this.searchs=[],this.flatData.forEach(e=>{let t=e.headerDom.parentElement;"none"==t.style.display&&t.removeAttribute("style")});return this.options.onSearched&&this.options.onSearched.call(this,this.searchs,e),"searched"in this.handlers&&this.emit("searched",this.searchs,e),t&&t.call(this,this.searchs,e),this.save(),this}check(e,t=!0,i){if(this.destroyed)return this;let o;if("Array"==axType(e)){o=this.flatData.filter(t=>e.includes(t.id));for(let e=0,i=o.length;e<i;e++){let i=o[e];i.checked!=t&&(i.checked=t,"checkbox"==this.options.checkType?this.eachCheckbox(i,this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(i,this.options.linkage))}}else{if(o=this.flatData.filter(t=>t.id==e),o.checked==t)return!1;o[0].checked=t,"checkbox"==this.options.checkType?this.eachCheckbox(o[0],this.options.linkage):"radio"==this.options.checkType&&this.eachRadio(o[0],this.options.linkage)}return this.options.onSetChecked&&this.options.onSetChecked.call(this,o),"setChecked"in this.handlers&&this.emit("setChecked",o),i&&i.call(this,o),this.save(),this}disable(e,t=!0,i){if(this.destroyed)return this;let o;if("Array"==axType(e)){o=this.flatData.filter(t=>e.includes(t.id));let i=[];o.forEach(e=>{i.push(...this.getChildren(e))}),i=[...i].filter((e,t)=>[...i].indexOf(e)==t),o.push(...i);for(let e=0,s=o.length;e<s;e++){let s=o[e];s.disabled!=t&&(s.disabled=t,this.eachDisabled(s),i.forEach(e=>{e.disabled=t,this.eachDisabled(e)}))}}else{if(o.disabled==t)return!1;o=this.flatData.filter(t=>t.id==e),this.getChildren(o[0]).forEach(e=>{e.disabled=t,this.eachDisabled(e)})}return o.forEach(e=>{e.disabled=t,this.clickCheck(e,this.flatData)}),this.options.onSetDisabled&&this.options.onSetDisabled.call(this,o),"setDisabled"in this.handlers&&this.emit("setDisabled",o),i&&i.call(this,o),this.save(),this}readonly(e,t=!0,i){if(this.destroyed)return this;let o=(e,t)=>{t?(e.readonly=!0,e.headerDom.setAttribute("readonly","true")):(e.readonly=!1,e.headerDom.removeAttribute("readonly"))},s=[];if("Array"==axType(e))s=this.flatData.filter(t=>e.includes(t.id)),s.forEach(e=>{o(e,t)});else if("Object"==axType(e))o(e,t),s.push(e);else{let i=this.flatData.filter(t=>t.id==e)[0];o(i,t),s.push(i)}return this.readonlys=[...this.readonlys,...s],this.readonlys=[...this.readonlys].filter((e,t)=>[...this.readonlys].indexOf(e)==t),this.options.onSetReadonly&&this.options.onSetReadonly.call(this,s),"setReadonly"in this.handlers&&this.emit("setReadonly",s),i&&i.call(this,s),this.save(),this}expand(e,t){if(this.destroyed)return this;let i=[];return i="Array"==axType(e)?this.flatData.filter(t=>!t.expanded&&t.children&&e.includes(t.id)):this.flatData.filter(t=>!t.expanded&&t.children&&e===t.id),i.forEach(e=>{e.expanded=!1,this.ulToggle(e,!1)}),this.expandeds=this.flatData.filter(e=>e.expanded&&e.children).map(e=>e.id),t&&t.call(this,i),this}expandAll(e){if(this.destroyed)return this;let t=this.flatData.filter(e=>!e.expanded&&e.children);return t.forEach(e=>{e.expanded=!1,this.ulToggle(e,!1)}),this.expandeds=t.map(e=>e.id),this.options.onExpandAll&&this.options.onExpandAll.call(this),"expandAll"in this.handlers&&this.emit("expandAll",""),e&&e.call(this),this}collapse(e,t){if(this.destroyed)return this;let i=[];return i="Array"==axType(e)?this.flatData.filter(t=>t.expanded&&t.children&&e.includes(t.id)):this.flatData.filter(t=>t.expanded&&t.children&&e===t.id),i.forEach(e=>{e.expanded=!0,this.ulToggle(e,!1)}),this.expandeds=this.flatData.filter(e=>e.expanded&&e.children).map(e=>e.id),t&&t.call(this,i),this}collapseAll(e){if(this.destroyed)return this;return this.flatData.filter(e=>e.expanded&&e.children).forEach(e=>{e.expanded=!0,this.ulToggle(e,!1)}),this.expandeds=[],this.options.onCollapseAll&&this.options.onCollapseAll.call(this),"collapseAll"in this.handlers&&this.emit("collapseAll",""),e&&e.call(this),this}reset(e){return this.destroyed?this:(this.targetDom.innerHTML=this.rawHTML?this.rawHTML:"",this.init(),this.options.onReset&&this.options.onReset.call(this),"reset"in this.handlers&&this.emit("reset",""),e&&e.call(this),this)}updateContent(e,t,i){if(this.destroyed)return this;let o=axFindItem(e,this.flatData);return o&&"string"==typeof t?(o.label=t,o.labelDom.innerHTML=t,this.options.onUpdateContent&&this.options.onUpdateContent.call(this,o),"updateContent"in this.handlers&&this.emit("updateContent",o),i&&i.call(this,o),this):void 0}update(e,t){return this.destroyed?this:(this.options=axExtend(this.options,e),this.options.storageName&&axLocalStorage.set(this.options.storageName,{}),this.targetDom.innerHTML=this.rawHTML?this.rawHTML:"",this.init(),"update"in this.handlers&&this.emit("update",""),this.options.onUpdate&&this.options.onUpdate.call(this),t&&t.call(this),this)}destroy(e){return this.flatData.forEach(e=>{e.labelDom.onclick=null,e.arrowDom.onclick=null,e.checkDom&&(e.checkDom.onclick=null),e.addDom&&(e.addDom.onclick=null),e.editDom&&(e.editDom.onclick=null),e.removeDom&&(e.removeDom.onclick=null),e.otherTools.forEach(e=>{e.dom.onclick=null})}),this.contentXhr&&this.contentXhr.abort(),this.destroyed=!0,this.options.storageName&&axLocalStorage.set(this.options.storageName,{}),"destroy"in this.handlers&&this.emit("destroy",""),this.options.onDestroy&&this.options.onDestroy.call(this),e&&e.call(this),this}save(e,t){return this.destroyed?this:!!this.options.storageName&&void setTimeout(()=>{let i=this.flatData.filter(e=>e.expanded).map(e=>e.id).filter(Boolean),o=this.flatData.filter(e=>e.disabled).map(e=>e.id).filter(Boolean),s=this.flatData.filter(e=>e.selected).map(e=>e.id).filter(Boolean),a=this.flatData.filter(e=>e.checked).map(e=>e.id).filter(Boolean),n=this.flatData.filter(e=>e.readonly).map(e=>e.id).filter(Boolean);e?(!e.hasOwnProperty("expanded")&&(e.expanded=i),!e.hasOwnProperty("disabled")&&(e.disabled=o),!e.hasOwnProperty("selected")&&(e.selected=s),!e.hasOwnProperty("checked")&&(e.checked=a),!e.hasOwnProperty("readonly")&&(e.readonly=n),!e.hasOwnProperty("content")&&(e.content=this.flatData),axLocalStorage.set(this.options.storageName,e)):axLocalStorage.set(this.options.storageName,{expanded:i,selected:s,checked:a,disabled:o,readonly:n,content:this.flatData});let h=axLocalStorage.get(this.options.storageName);return"save"in this.handlers&&this.emit("save",h),this.options.onSave&&this.options.onSave.call(this,h),t&&t.call(this,h),this},0)}on(e,t){return axAddPlan(e,t,this),this}emit(e,...t){axExePlan(e,this,...t)}off(e,t){return axDelPlan(e,t,this),this}}document.querySelectorAll("[axTree]").forEach(t=>{new e(t)});